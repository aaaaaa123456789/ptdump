{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Data file content description",
  "description": "Document that describes the contents of a data file as generated by this tool. The document only contains the data file's data structures and information about detected partitions; the actual block contents are not contained in this document. (Rather, their locations are referenced, so that said blocks can be extracted from the binary data file.)",
  "type": "array",
  "minItems": 1,
  "items": {
    "title": "Logical file",
    "description": "Data for each logical file contained in the data file.",
    "type": "object",
    "required": ["filename", "block_size", "partition_type", "blocks", "effective_blocks"],
    "properties": {
      "filename": {
        "title": "Logical file name",
        "description": "Logical file name; non-empty and unique for each file. If the name (as stored in the data file) is not a valid UTF-8 string, this property will be an array of bytes.",
        "$comment": "String constraints (minLength, maxLength) apply to strings; array constraints (minItems, maxItems, items) apply for non-UTF-8 values.",
        "type": ["string", "array"],
        "minLength": 1,
        "maxLength": 65535,
        "minItems": 1,
        "maxItems": 65535,
        "items": {
          "type": "integer",
          "minimum": 0,
          "maximum": 255
        }
      },
      "block_size": {
        "title": "Block size",
        "description": "Size of each block in the logical file, in bytes.",
        "type": "integer",
        "minimum": 4,
        "maximum": 262144,
        "multipleOf": 4
      },
      "partition_type": {
        "title": "Detected partition table type",
        "description": "Detected partition table type for the logical file, if any, based on the block data stored in the data file.",
        "enum": ["none", "MBR", "GPT", "invalid"]
      },
      "blocks": {
        "title": "Block data",
        "description": "Location and size of the block data contained in the data file for this logical file.",
        "$ref": "#/$defs/blocks"
      },
      "effective_blocks": {
        "title": "Effective block data",
        "description": "Location and size of the block data contained in the data file after block number deduplication.",
        "$ref": "#/$defs/blocks"
      }
    },
    "anyOf": [
      {
        "$comment": "No partition table detected, or the detected partition table is invalid.",
        "properties": {"partition_type": {"enum": ["none", "invalid"]}}
      }, {
        "$comment": "MBR partition table: information is available for both primary and extended partitions.",
        "required": ["diskID", "extended_partition_tables", "partitions"],
        "properties": {
          "partition_type": {"const": "MBR"},
          "diskID": {
            "title": "Disk identifier",
            "description": "Disk identifier, stored in the MBR header. This is a 32-bit little-endian value.",
            "type": "integer",
            "minimum": 0,
            "maximum": 4294967295
          },
          "extended_partition_tables": {
            "title": "Extended partition tables",
            "description": "Tables describing extended partitions, forming a linked list. Each table will typically contain one data partition.",
            "type": "array",
            "items": {
              "type": "object",
              "required": ["block", "parent", "entry"],
              "properties": {
                "block": {
                  "title": "Extended partition table block",
                  "description": "Block where this extended partition table is located.",
                  "type": "integer",
                  "minimum": 1
                },
                "parent": {
                  "title": "Extended partition table parent",
                  "description": "Location of the partition table that references this partition table. If this table is referenced directly by the primary table in the MBR, this value will be 0; otherwise, it will be another extended partition table's block.",
                  "type": "integer",
                  "minimum": 0
                },
                "entry": {
                  "title": "Extended partition table parent entry",
                  "description": "Entry number in the parent partition table that references this extended partition table.",
                  "type": "integer",
                  "minimum": 1,
                  "maximum": 4
                }
              },
              "additionalProperties": false
            }
          },
          "partitions": {
            "title": "Partitions",
            "description": "Partition table entries, both in the primary (MBR) table and in the extended tables. Primary partitions are numbered 1-4; extended partitions are numbered starting from 5.",
            "type": "array",
            "items": {
              "$ref": "#/$defs/partition",
              "required": ["typeID", "table", "entry", "startCHS", "endCHS", "status"],
              "properties": {
                "typeID": {
                  "title": "Partition type ID",
                  "description": "Numeric value identifying the partition type for this partition. This is a single-byte value, and many values have been reused by multiple operating systems, so partition type detection may be ambiguous.",
                  "type": "integer",
                  "minimum": 0,
                  "maximum": 255
                },
                "table": {
                  "title": "Partition parent table",
                  "description": "Location of the partition table that contains this partition. For primary partitions, referenced directly by the MBR, this value will be 0; for extended partitions, it will be the location of some extended partition table.",
                  "type": "integer",
                  "minimum": 0
                },
                "entry": {
                  "title": "Partition parent table entry",
                  "description": "Entry number in the containing partition table that references this partition. For primary partitions, this value will be equal to the partition number.",
                  "type": "integer",
                  "minimum": 1,
                  "maximum": 4
                },
                "startCHS": {
                  "title": "Partition starting CHS",
                  "description": "Partition starting position, in cylinder-head-sector coordinates (as a three-element array). This value is ignored by all modern operating systems.",
                  "$ref": "#/$defs/CHS"
                },
                "endCHS": {
                  "title": "Partition ending CHS",
                  "description": "Partition ending position, in cylinder-head-sector coordinates (as a three-element array), representing the last sector of the partition. This value is ignored by all modern operating systems.",
                  "$ref": "#/$defs/CHS"
                },
                "status": {
                  "title": "Partition status field",
                  "description": "Single-byte value describing the partition status. Normally, the only values in use are 128 for bootable partitions and 0 otherwise.",
                  "type": "integer",
                  "minimum": 0,
                  "maximum": 255
                }
              },
              "unevaluatedProperties": false
            }
          }
        }
      }, {
        "$comment": "GPT partition table.",
        "required": ["diskID", "first_block", "last_block", "partition_tables", "partitions"],
        "properties": {
          "partition_type": {"const": "GPT"},
          "diskID": {
            "title": "Disk identifier",
            "description": "Disk identifier, stored in the GPT header.",
            "$ref": "#/$defs/GUID"
          },
          "first_block": {
            "title": "Disk's first data block",
            "description": "First block in the disk available for partitions. Partitions must not begin before this block.",
            "type": "integer",
            "minimum": 2
          },
          "last_block": {
            "title": "Disk's last data block",
            "description": "Last data block in the disk available for partitions, inclusive. Partitions must not end beyond this block.",
            "$comment": "The minimum here makes little sense: the last block is at the end of the disk. Its main purpose is to indicate that the value is always positive.",
            "type": "integer",
            "minimum": 2
          },
          "partition_tables": {
            "title": "Partition tables",
            "description": "Partition tables found in the disk. The GPT specification calls for two, but invalid disks may have a different number.",
            "type": "array",
            "items": {
              "type": "object",
              "required": ["header", "data", "blocks", "entries", "entry_size", "valid", "matching"],
              "properties": {
                "header": {
                  "title": "Partition table header location",
                  "description": "Location (block number) of the GPT header for this partition table.",
                  "type": "integer",
                  "minimum": 1
                },
                "data": {
                  "title": "Partition table data location",
                  "description": "Location (starting block number) of the partition table itself.",
                  "type": "integer",
                  "minimum": 2
                },
                "blocks": {
                  "title": "Partition table length (blocks)",
                  "description": "Partition table length, in blocks. This may include padding at the end of the table.",
                  "type": "integer",
                  "minimum": 1
                },
                "entries": {
                  "title": "Partition table length (entries)",
                  "description": "Partition table length, in entries. By the specification, this value must be at least 128.",
                  "$comment": "By the specification, the minimum is 128. But implementations will probably happily accept smaller disks, so that constraint is not enforced here.",
                  "type": "integer",
                  "minimum": 1
                },
                "entry_size": {
                  "title": "Partition table entry size",
                  "description": "Size, in bytes, of each entry in the partition table. Entries must be at least 128 bytes long, and the specification expects this value to be a power of two.",
                  "$comment": "Even though the specification asks for a power of two, older versions allowed any multiple of 8. The weaker constraint is enforced here.",
                  "type": "integer",
                  "minimum": 128,
                  "multipleOf": 8
                },
                "valid": {
                  "title": "Partition table valid",
                  "description": "Flag that indicates whether the partition table is valid, i.e., whether the integrity checks passed. Invalid partition tables are ignored; the partition type will be set to 'invalid' if no partition tables are valid.",
                  "type": "boolean"
                },
                "matching": {
                  "title": "Partition table matches primary",
                  "description": "Flag that indicates whether this partition table matches the one selected as primary (i.e., used to dump partition information). This flag will be set to null for the primary table itself, and it will be set to false when the valid flag is set to false.",
                  "type": ["boolean", "null"]
                }
              },
              "additionalProperties": false
            }
          },
          "partitions": {
            "title": "Partitions",
            "description": "Partition table entries. Only entries from the partition table selected as primary (i.e., the table with matching = null) are included here.",
            "type": "array",
            "items": {
              "$ref": "#/$defs/partition",
              "required": ["typeID", "partID", "attributes", "required"],
              "properties": {
                "typeID": {
                  "title": "Partition type ID",
                  "description": "GUID identifying the partition type for this partition. The partition type will be derived from this value when known.",
                  "$ref": "#/$defs/GUID"
                },
                "partID": {
                  "title": "Partition ID",
                  "description": "GUID identifying the partition itself. This value is expected to be globally unique, and many operating systems will either modify it or malfunction when encountering duplicate partition IDs across all disks they can see.",
                  "$ref": "#/$defs/GUID"
                },
                "label": {
                  "title": "Partition label",
                  "description": "Label describing the partition, typically set by the operating system. This value will be unset if the label is empty.",
                  "default": "",
                  "type": "string",
                  "maxLength": 36
                },
                "attributes": {
                  "title": "Partition attribute flags",
                  "description": "Flags indicating partition attributes. This value is an array indicating which bit positions are set, in ascending order.",
                  "type": "array",
                  "uniqueItems": true,
                  "items": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 63
                  }
                },
                "required": {
                  "title": "Partition required (system) flag",
                  "description": "Flag indicating that the partition is required for the system to function.",
                  "type": "boolean"
                }
              },
              "unevaluatedProperties": false
            }
          }
        }
      }
    ],
    "unevaluatedProperties": false
  },
  "$defs": {
    "blocks": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["number", "offset", "count"],
        "properties": {
          "number": {
            "title": "Block number",
            "description": "Block number in the logical data file for the blocks described by this entry. If it describes more than one block (i.e., if count > 1), subsequent blocks will have consecutive block numbers.",
            "type": "integer",
            "minimum": 0
          },
          "offset": {
            "title": "Data file offset",
            "description": "Offset into the data file where the block data begins for all the blocks described by this entry. (The data is stored raw and can be copied out of the data file directly.)",
            "type": "integer",
            "minimum": 0,
            "multipleOf": 4
          },
          "count": {
            "title": "Block count",
            "description": "Length of the block span described by this entry, in blocks. (The actual data size can be determined by multiplying by the block size.)",
            "type": "integer",
            "minimum": 1
          }
        },
        "additionalProperties": false
      }
    },
    "CHS": {
      "$comment": "CHS location, used twice in MBR partition tables.",
      "type": "array",
      "minItems": 3,
      "maxItems": 3,
      "prefixItems": [
        {
          "title": "Cylinder",
          "type": "integer",
          "minimum": 0,
          "maximum": 1023
        },
        {
          "title": "Head",
          "$comment": "Even though 255 is not a value typically seen (due to an ancient DOS bug), it's not invalid.",
          "type": "integer",
          "minimum": 0,
          "maximum": 255
        },
        {
          "title": "Sector",
          "$comment": "0 is an invalid value for this field: CHS sectors are numbered from 1. However, it is representable, and thus it could be encountered.",
          "type": "integer",
          "minimum": 0,
          "maximum": 63
        }
      ]
    },
    "GUID": {
      "$comment": "GUID, in the only format emitted by the program. This type is reused throughout the GPT data.",
      "type": "string",
      "pattern": "^[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}$",
      "minLength": 36,
      "maxLength": 36
    },
    "partition": {
      "$comment": "Common fields for partition entries, regardless of partition table type.",
      "type": "object",
      "required": ["number", "start", "length", "bootable"],
      "properties": {
        "number": {
          "title": "Partition number",
          "description": "Logical partition number, as referenced by the operating system.",
          "type": "integer",
          "minimum": 1
        },
        "start": {
          "title": "Partition starting block",
          "description": "Partition starting position, in blocks. This value, along with the length, locates the partition on the disk.",
          "type": "integer",
          "minimum": 1
        },
        "length": {
          "title": "Partition size",
          "description": "Partition size, in blocks. This value, along with the start, locates the partition on the disk.",
          "type": "integer",
          "minimum": 1
        },
        "type": {
          "title": "Partition type",
          "description": "Partition type, if known. (This is determined from the partition table, not by inspecting the partition itself.)",
          "type": "string",
          "minLength": 1
        },
        "bootable": {
          "title": "Bootable partition",
          "description": "Flag that indicates whether the partition is bootable by a legacy (i.e., non-UEFI) BIOS.",
          "type": "boolean"
        }
      }
    }
  }
}
